// ä»è½¬å†™æ–‡æœ¬ä¸­åˆ†æè¾©è®ºå†…å®¹çš„ç³»ç»Ÿ - LLMå¢å¼ºç‰ˆ
import { TranscriptItem } from '../../types';
import { getCurrentDebateState, setDebateTopic } from './debateAnalyzer';
import { extractUserSpeeches, analyzeSpeeches } from './llmAnalyzer';

// ===== LLMé©±åŠ¨çš„è¯­ä¹‰åˆ†æç³»ç»Ÿ =====

// æ›´æ–°è¾©è®ºçŠ¶æ€ï¼ˆä½¿ç”¨LLMåˆ†æï¼‰
export async function updateDebateStateFromTranscript(transcriptItems: TranscriptItem[]) {
  const speeches = extractUserSpeeches(transcriptItems);
  
  if (speeches.length === 0) {
    console.log('ğŸ“­ æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·å‘è¨€');
    return getCurrentDebateState();
  }

  console.log('ğŸ¤– å¼€å§‹LLMè¯­ä¹‰åˆ†æ:', speeches);

  try {
    // ä½¿ç”¨LLMè¿›è¡Œæ™ºèƒ½åˆ†æ
    const analysis = await analyzeSpeeches(speeches);
    
    // è‡ªåŠ¨è®¾ç½®è¾©è®ºä¸»é¢˜
    if (analysis.topic) {
      setDebateTopic(analysis.topic);
      console.log('ğŸ¯ æ£€æµ‹åˆ°è¾©è®ºä¸»é¢˜:', analysis.topic);
    }

    // è®¡ç®—èƒœç‡ - åŸºäºå‘è¨€æ•°é‡å’Œè´¨é‡
    const totalSpeeches = analysis.positive.speeches.length + analysis.negative.speeches.length;
    const positiveRate = totalSpeeches > 0 ? Math.round((analysis.positive.speeches.length / totalSpeeches) * 100) : 50;
    const negativeRate = 100 - positiveRate;

    // æ›´æ–°å…¨å±€çŠ¶æ€
    const currentState = getCurrentDebateState();
    
    // ä½¿ç”¨LLMç”Ÿæˆçš„æ±‡æ€»è§‚ç‚¹
    currentState.participants.positive.keyPoints = analysis.positive.consolidatedViewpoint ? 
      [analysis.positive.consolidatedViewpoint] : [];
    currentState.participants.negative.keyPoints = analysis.negative.consolidatedViewpoint ? 
      [analysis.negative.consolidatedViewpoint] : [];
      
    currentState.participants.positive.speechCount = analysis.positive.speeches.length;
    currentState.participants.negative.speechCount = analysis.negative.speeches.length;
    
    // ä½¿ç”¨LLMç”Ÿæˆçš„æ™ºèƒ½æ ‡ç­¾
    currentState.keywords.positive = analysis.positive.smartTags || [];
    currentState.keywords.negative = analysis.negative.smartTags || [];
    
    currentState.winRate.positive = positiveRate;
    currentState.winRate.negative = negativeRate;

    console.log('âœ… LLMåˆ†æå®Œæˆï¼ŒçŠ¶æ€å·²æ›´æ–°:', {
      æ€»å‘è¨€: totalSpeeches,
      æ­£æ–¹è§‚ç‚¹: analysis.positive.consolidatedViewpoint,
      åæ–¹è§‚ç‚¹: analysis.negative.consolidatedViewpoint,
      æ­£æ–¹æ ‡ç­¾: analysis.positive.smartTags,
      åæ–¹æ ‡ç­¾: analysis.negative.smartTags,
      èƒœç‡åˆ†å¸ƒ: `${positiveRate}% vs ${negativeRate}%`
    });
    
    return currentState;
    
  } catch (error) {
    console.error('âŒ LLMåˆ†æå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
    return fallbackAnalysis(speeches);
  }
}

// å¤‡ç”¨åˆ†ææ–¹æ¡ˆï¼ˆå½“LLMä¸å¯ç”¨æ—¶ï¼‰
function fallbackAnalysis(speeches: string[]) {
  console.log('ğŸ”„ ä½¿ç”¨è§„åˆ™å¤‡ç”¨åˆ†æ');
  
  const currentState = getCurrentDebateState();
  
  // ç®€å•çš„äº¤æ›¿åˆ†é…
  const positiveSpeeches: string[] = [];
  const negativeSpeeches: string[] = [];
  
  speeches.forEach((speech, index) => {
    if (speech.length < 5) return;
    
    if (index % 2 === 0) {
      positiveSpeeches.push(speech);
    } else {
      negativeSpeeches.push(speech);
    }
  });
  
  // æ›´æ–°çŠ¶æ€
  currentState.participants.positive.keyPoints = positiveSpeeches.slice(-1);
  currentState.participants.negative.keyPoints = negativeSpeeches.slice(-1);
  currentState.participants.positive.speechCount = positiveSpeeches.length;
  currentState.participants.negative.speechCount = negativeSpeeches.length;
  
  const totalSpeeches = positiveSpeeches.length + negativeSpeeches.length;
  const positiveRate = totalSpeeches > 0 ? Math.round((positiveSpeeches.length / totalSpeeches) * 100) : 50;
  
  currentState.winRate.positive = positiveRate;
  currentState.winRate.negative = 100 - positiveRate;
  
  return currentState;
}

// ä»è½¬å†™æ–‡æœ¬ä¸­æå–æ‰€æœ‰ç”¨æˆ·å‘è¨€ - æ”¹è¿›ç‰ˆ
export function extractUserSpeeches(transcriptItems: TranscriptItem[]): string[] {
  return transcriptItems
    .filter(item => item.type === 'MESSAGE' && item.role === 'user')
    .map(item => {
      // ä¼˜å…ˆä»realtimeè½¬å†™æ•°æ®ä¸­æå–
      let text = '';
      
      if (typeof item.data === 'string') {
        text = item.data;
      } else if (item.data && typeof item.data === 'object') {
        // ä¼˜å…ˆä½¿ç”¨realtime APIçš„transcriptå­—æ®µ
        text = item.data.transcript || item.data.text || item.data.content || '';
      }
      
      if (!text && item.title) {
        text = item.title;
      }
      
      return text.trim();
    })
    .filter(text => {
      // è¿‡æ»¤æ— æ„ä¹‰çš„çŸ­è¯­å’Œå¸¸è§å›åº”
      if (text.length < 3) return false;
      
      const meaninglessWords = [
        'å¥½çš„', 'å—¯', 'å•Š', 'å“¦', 'å‘ƒ', 'é¢', 'å—¯å—¯', 'å¯¹', 'æ˜¯çš„', 'å¥½', 'è¡Œ',
        'çŸ¥é“äº†', 'æ˜ç™½äº†', 'æ”¶åˆ°', 'ok', 'OK', 'yes', 'yeah', 'å—¯å“¼'
      ];
      
      return !meaninglessWords.includes(text) && !meaninglessWords.some(word => text === word);
    });
}

// æ™ºèƒ½åˆ†ææ‰€æœ‰å‘è¨€ - å¢å¼ºç‰ˆ
export function analyzeAllSpeeches(speeches: string[]) {
  console.log('ğŸ” å¼€å§‹æ™ºèƒ½åˆ†æå‘è¨€:', speeches.length, 'æ¡');
  
  const results = {
    positive: {
      speeches: [] as string[],
      consolidatedViewpoint: '', // æ±‡æ€»è§‚ç‚¹
      smartTags: [] as string[] // æ™ºèƒ½æ ‡ç­¾
    },
    negative: {
      speeches: [] as string[],
      consolidatedViewpoint: '', // æ±‡æ€»è§‚ç‚¹
      smartTags: [] as string[] // æ™ºèƒ½æ ‡ç­¾
    }
  };

  // å…ˆåˆ†ç±»æ‰€æœ‰å‘è¨€
  speeches.forEach((speech, index) => {
    const stance = identifyStanceFromText(speech, index, speeches.slice(0, index));
    
    if (stance === 'positive') {
      results.positive.speeches.push(speech);
    } else if (stance === 'negative') {
      results.negative.speeches.push(speech);
    }
  });

  // ç”Ÿæˆæ±‡æ€»è§‚ç‚¹å’Œæ™ºèƒ½æ ‡ç­¾
  results.positive.consolidatedViewpoint = generateConsolidatedViewpoint(results.positive.speeches);
  results.negative.consolidatedViewpoint = generateConsolidatedViewpoint(results.negative.speeches);
  
  results.positive.smartTags = generateSmartTags(results.positive.speeches);
  results.negative.smartTags = generateSmartTags(results.negative.speeches);

  console.log('ğŸ“Š åˆ†æå®Œæˆ:', {
    æ­£æ–¹å‘è¨€æ•°: results.positive.speeches.length,
    åæ–¹å‘è¨€æ•°: results.negative.speeches.length,
    æ­£æ–¹æ±‡æ€»è§‚ç‚¹: results.positive.consolidatedViewpoint,
    åæ–¹æ±‡æ€»è§‚ç‚¹: results.negative.consolidatedViewpoint
  });

  return results;
}

// ç”Ÿæˆæ±‡æ€»è§‚ç‚¹ - åŠ¨æ€æ›´æ–°ç‰ˆ
function generateConsolidatedViewpoint(speeches: string[]): string {
  if (speeches.length === 0) return '';
  
  // æŒ‰æ—¶é—´é¡ºåºï¼Œæœ€æ–°çš„å‘è¨€æƒé‡æ›´é«˜
  const recentSpeeches = speeches.slice(-3); // å–æœ€è¿‘3æ¡å‘è¨€
  
  // æå–å®è´¨æ€§è§‚ç‚¹
  const meaningfulPoints: string[] = [];
  
  recentSpeeches.forEach(speech => {
    // è¿‡æ»¤æ‰çº¯ç²¹çš„åŒæ„/åå¯¹è¯ï¼Œå¯»æ‰¾å®è´¨æ€§å†…å®¹
    if (speech.length > 10) { // è‡³å°‘10ä¸ªå­—ç¬¦æ‰è€ƒè™‘
      const cleanedSpeech = speech
        .replace(/^(æˆ‘è§‰å¾—|æˆ‘è®¤ä¸º|æˆ‘æƒ³|æˆ‘è§‰å¾—è¯´|å°±æ˜¯è¯´|å…¶å®)/g, '')
        .replace(/(å¥½çš„|å¯¹çš„|æ˜¯çš„|æ²¡é”™)$/g, '')
        .trim();
      
      if (cleanedSpeech.length > 5) {
        meaningfulPoints.push(cleanedSpeech);
      }
    }
  });
  
  if (meaningfulPoints.length === 0) {
    // å¦‚æœæ²¡æœ‰å®è´¨æ€§è§‚ç‚¹ï¼Œè¿”å›æœ€åä¸€æ¡å‘è¨€çš„æ¸…ç†ç‰ˆæœ¬
    const lastSpeech = speeches[speeches.length - 1];
    return lastSpeech.length > 20 ? lastSpeech.substring(0, 50) + '...' : lastSpeech;
  }
  
  // é€‰æ‹©æœ€æ–°ä¸”æœ€æœ‰ä»£è¡¨æ€§çš„è§‚ç‚¹
  const latestMeaningfulPoint = meaningfulPoints[meaningfulPoints.length - 1];
  
  // ç”Ÿæˆä¸€å¥è¯æ€»ç»“ï¼Œä¸è¶…è¿‡50å­—
  const summary = latestMeaningfulPoint.length > 50 
    ? latestMeaningfulPoint.substring(0, 50) + '...'
    : latestMeaningfulPoint;
    
  return summary;
}

// ç”Ÿæˆæ™ºèƒ½æ ‡ç­¾
function generateSmartTags(speeches: string[]): string[] {
  if (speeches.length === 0) return [];
  
  const allText = speeches.join(' ');
  const rawKeywords = extractKeywordsFromText(allText);
  
  // æ™ºèƒ½å¤„ç†å…³é”®è¯ï¼Œç”Ÿæˆç®€çŸ­æ ‡ç­¾
  const smartTags = rawKeywords
    .filter(keyword => keyword.length >= 2 && keyword.length <= 6) // åˆé€‚é•¿åº¦
    .map(keyword => refineKeyword(keyword)) // ç²¾ç‚¼å…³é”®è¯
    .filter((tag, index, arr) => arr.indexOf(tag) === index) // å»é‡
    .slice(0, 6); // é™åˆ¶æ•°é‡
  
  return smartTags;
}

// ç²¾ç‚¼å…³é”®è¯
function refineKeyword(keyword: string): string {
  // ç§»é™¤å¸¸è§çš„æ— æ„ä¹‰è¯æ±‡
  const stopWords = ['æˆ‘ä»¬', 'è¿™ä¸ª', 'é‚£ä¸ª', 'ä¸€ä¸ª', 'å¯ä»¥', 'åº”è¯¥', 'éœ€è¦', 'å› ä¸º', 'æ‰€ä»¥'];
  
  if (stopWords.includes(keyword)) return '';
  
  // æå–æ ¸å¿ƒæ¦‚å¿µ
  if (keyword.includes('æŠ€æœ¯')) return 'æŠ€æœ¯';
  if (keyword.includes('ç¯å¢ƒ')) return 'ç¯å¢ƒ';
  if (keyword.includes('ç»æµ')) return 'ç»æµ';
  if (keyword.includes('ç¤¾ä¼š')) return 'ç¤¾ä¼š';
  if (keyword.includes('æ•™è‚²')) return 'æ•™è‚²';
  if (keyword.includes('å¥åº·')) return 'å¥åº·';
  
  return keyword;
}

// æå–å…³é”®è§‚ç‚¹
// æå–å…³é”®è¯ - æ”¹è¿›ç‰ˆï¼Œä¸¥æ ¼è¿‡æ»¤æ— æ„ä¹‰è¯æ±‡
function extractKeywordsFromText(text: string): string[] {
  // æ‰©å±•çš„åœç”¨è¯åˆ—è¡¨
  const stopWords = [
    // åŸºç¡€è¿æ¥è¯å’Œä»£è¯
    'ä½†æ˜¯', 'ç„¶å', 'å› ä¸º', 'æ‰€ä»¥', 'å¦‚æœ', 'è™½ç„¶', 'è™½è¯´', 'å¯æ˜¯', 'ä¸è¿‡', 
    'è¿™ä¸ª', 'é‚£ä¸ª', 'ä»€ä¹ˆ', 'æ€ä¹ˆ', 'ä¸ºä»€ä¹ˆ', 'å“ªé‡Œ', 'å“ªä¸ª', 'æ€æ ·',
    
    // è¯­æ°”è¯å’Œå›åº”è¯
    'å¥½çš„', 'å—¯å—¯', 'å¯¹çš„', 'æ˜¯çš„', 'æ²¡é”™', 'å½“ç„¶', 'ç¡®å®', 'åº”è¯¥', 'å¯ä»¥',
    'éœ€è¦', 'å¿…é¡»', 'èƒ½å¤Ÿ', 'å¯èƒ½', 'ä¹Ÿè®¸', 'å¤§æ¦‚', 'å·®ä¸å¤š', 'çŸ¥é“', 'æ˜ç™½',
    
    // ç¨‹åº¦è¯å’Œæ—¶é—´è¯
    'éå¸¸', 'ç‰¹åˆ«', 'å¾ˆå¤š', 'ä¸€äº›', 'æ‰€æœ‰', 'å…¨éƒ¨', 'ç°åœ¨', 'ä»Šå¤©', 'ä»¥å‰',
    'ä»¥å', 'æ€»æ˜¯', 'ç»å¸¸', 'æœ‰æ—¶', 'å·²ç»', 'æ­£åœ¨', 'å°†è¦', 'åˆšåˆš',
    
    // æ— æ„ä¹‰çŸ­è¯­
    'è°¢è°¢', 'ä¸å¥½æ„æ€', 'è¯·é—®', 'çŸ¥é“äº†', 'æ˜ç™½äº†', 'æ”¶åˆ°äº†', 'å¥½å§'
  ];

  // æå–ä¸­æ–‡è¯æ±‡ï¼ˆ2-6å­—ç¬¦ï¼‰
  const chineseWords = text.match(/[\u4e00-\u9fa5]{2,6}/g) || [];
  
  // æå–è‹±æ–‡è¯æ±‡
  const englishWords = text.match(/[a-zA-Z]{3,8}/g) || [];
  
  // åˆå¹¶å¹¶è¿‡æ»¤
  const allWords = [...chineseWords, ...englishWords];
  
  const filteredWords = allWords.filter(word => {
    const lowerWord = word.toLowerCase();
    
    // è¿‡æ»¤åœç”¨è¯
    if (stopWords.includes(word) || stopWords.includes(lowerWord)) return false;
    
    // è¿‡æ»¤çº¯æ•°å­—æˆ–æ— æ„ä¹‰å­—ç¬¦
    if (/^\d+$/.test(word) || /^[^\u4e00-\u9fa5a-zA-Z]+$/.test(word)) return false;
    
    // ä¿ç•™æœ‰å®é™…å«ä¹‰çš„è¯æ±‡
    return word.length >= 2;
  });

  // è¯é¢‘ç»Ÿè®¡å¹¶å»é‡
  const wordFreq: Record<string, number> = {};
  filteredWords.forEach(word => {
    wordFreq[word] = (wordFreq[word] || 0) + 1;
  });

  // è¿”å›é¢‘ç‡æœ€é«˜ä¸”æœ‰æ„ä¹‰çš„å…³é”®è¯
  return Object.entries(wordFreq)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 6) // å¢åŠ åˆ°6ä¸ªå…³é”®è¯
    .map(([word]) => word)
    .filter(word => word.length >= 2); // ç¡®ä¿éƒ½æ˜¯æœ‰æ„ä¹‰çš„è¯æ±‡
}

// æ›´æ–°è¾©è®ºçŠ¶æ€ï¼ˆä¸ä¾èµ–å·¥å…·è°ƒç”¨ï¼‰
export function updateDebateStateFromTranscript(transcriptItems: TranscriptItem[]) {
  const speeches = extractUserSpeeches(transcriptItems);
  
  if (speeches.length === 0) {
    console.log('æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·å‘è¨€');
    return getCurrentDebateState();
  }

  const analysis = analyzeAllSpeeches(speeches);
  
  // è‡ªåŠ¨æ£€æµ‹è¾©è®ºä¸»é¢˜
  const topic = detectDebateTopic(speeches);
  if (topic) {
    setDebateTopic(topic);
  }

  // è®¡ç®—èƒœç‡ - åŸºäºå‘è¨€æ•°é‡
  const totalSpeeches = analysis.positive.speeches.length + analysis.negative.speeches.length;
  const positiveRate = totalSpeeches > 0 ? Math.round((analysis.positive.speeches.length / totalSpeeches) * 100) : 50;
  const negativeRate = 100 - positiveRate;

  // æ›´æ–°å…¨å±€çŠ¶æ€ - ä½¿ç”¨æ±‡æ€»æ¨¡å¼
  const currentState = getCurrentDebateState();
  
  // ä½¿ç”¨æ±‡æ€»è§‚ç‚¹æ›¿ä»£ç´¯ç§¯è§‚ç‚¹
  currentState.participants.positive.keyPoints = analysis.positive.consolidatedViewpoint ? 
    [analysis.positive.consolidatedViewpoint] : [];
  currentState.participants.negative.keyPoints = analysis.negative.consolidatedViewpoint ? 
    [analysis.negative.consolidatedViewpoint] : [];
    
  currentState.participants.positive.speechCount = analysis.positive.speeches.length;
  currentState.participants.negative.speechCount = analysis.negative.speeches.length;
  
  // ä½¿ç”¨æ™ºèƒ½æ ‡ç­¾æ›¿ä»£å…³é”®è¯
  currentState.keywords.positive = analysis.positive.smartTags || [];
  currentState.keywords.negative = analysis.negative.smartTags || [];
  
  currentState.winRate.positive = positiveRate;
  currentState.winRate.negative = negativeRate;

  console.log('âœ… æ›´æ–°åçš„è¾©è®ºçŠ¶æ€ (æ±‡æ€»æ¨¡å¼):', {
    æ€»å‘è¨€: totalSpeeches,
    æ­£æ–¹è§‚ç‚¹æ±‡æ€»: analysis.positive.consolidatedViewpoint,
    åæ–¹è§‚ç‚¹æ±‡æ€»: analysis.negative.consolidatedViewpoint,
    æ­£æ–¹æ™ºèƒ½æ ‡ç­¾: analysis.positive.smartTags,
    åæ–¹æ™ºèƒ½æ ‡ç­¾: analysis.negative.smartTags,
    èƒœç‡åˆ†å¸ƒ: `${positiveRate}% vs ${negativeRate}%`
  });
  
  return currentState;
}

// æ£€æµ‹è¾©è®ºä¸»é¢˜
function detectDebateTopic(speeches: string[]): string {
  // åˆå¹¶æ‰€æœ‰å‘è¨€
  const allText = speeches.join(' ');
  
  // å¯»æ‰¾ä¸»é¢˜ç›¸å…³çš„å…³é”®è¯ç»„åˆ
  const topicKeywords = allText.match(/å…³äº|è®¨è®º|è¾©è®º|ä¸»é¢˜|è¯é¢˜/g);
  if (topicKeywords) {
    // å°è¯•æå–ä¸»é¢˜æè¿°
    const topicMatch = allText.match(/(å…³äº|è®¨è®º|è¾©è®º|ä¸»é¢˜|è¯é¢˜)([^ã€‚ï¼ï¼Ÿ.!?]{5,30})/);
    if (topicMatch) {
      return topicMatch[2].trim();
    }
  }

  // åŸºäºé«˜é¢‘å…³é”®è¯æ¨æµ‹ä¸»é¢˜
  const keywords = extractKeywordsFromText(allText);
  if (keywords.length >= 2) {
    return keywords.slice(0, 3).join('ã€') + 'ç›¸å…³è¯é¢˜';
  }

  return 'è¾©è®ºè¯é¢˜';
}
